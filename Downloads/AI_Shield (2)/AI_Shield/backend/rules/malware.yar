/*
   AI Shield - YARA Malware Detection Rules
   These rules detect common malware patterns and behaviors
*/

rule PowerShell_EncodedCommand {
    meta:
        description = "Detects PowerShell with encoded commands (common in malware)"
        severity = "high"
    strings:
        $a = "powershell" wide ascii nocase
        $b = /FromBase64String/ wide ascii nocase
        $c = /-EncodedCommand/ wide ascii nocase
        $d = /Invoke-Expression/ wide ascii nocase
        $e = /IEX/ wide ascii nocase
    condition:
        2 of them
}

rule Process_Injection {
    meta:
        description = "Detects process injection techniques"
        severity = "high"
    strings:
        $mz = {4D 5A}
        $alloc = /VirtualAlloc/ ascii nocase
        $writeproc = /WriteProcessMemory/ ascii nocase
        $createremote = /CreateRemoteThread/ ascii nocase
        $virtualprotect = /VirtualProtect/ ascii nocase
    condition:
        $mz and (3 of ($alloc, $writeproc, $createremote, $virtualprotect))
}

rule Registry_Persistence {
    meta:
        description = "Detects registry-based persistence mechanisms"
        severity = "medium"
    strings:
        $reg1 = /HKEY_CURRENT_USER/ ascii nocase
        $reg2 = /HKEY_LOCAL_MACHINE/ ascii nocase
        $run = /RunOnce/ ascii nocase
        $runonce = /RunOnceEx/ ascii nocase
        $startup = /Startup/ ascii nocase
        $regset = /RegSetValue/ ascii nocase
    condition:
        (1 of ($reg1, $reg2)) and (2 of ($run, $runonce, $startup, $regset))
}

rule Network_Exfiltration {
    meta:
        description = "Detects network exfiltration patterns"
        severity = "medium"
    strings:
        $http = /http:\/\/[a-zA-Z0-9\.\-]+/ ascii
        $https = /https:\/\/[a-zA-Z0-9\.\-]+/ ascii
        $socket = /socket/ ascii nocase
        $connect = /connect/ ascii nocase
        $send = /send/ ascii nocase
        $recv = /recv/ ascii nocase
        $download = /DownloadString/ ascii nocase
    condition:
        (1 of ($http, $https)) and (2 of ($socket, $connect, $send, $recv, $download))
}

rule Obfuscation_Base64 {
    meta:
        description = "Detects Base64 obfuscation with execution"
        severity = "high"
    strings:
        $b64 = /[A-Za-z0-9+\/]{50,}={0,2}/ ascii
        $eval = /eval\(/ ascii nocase
        $unescape = /unescape\(/ ascii nocase
        $atob = /atob\(/ ascii nocase
    condition:
        $b64 and (1 of ($eval, $unescape, $atob))
}

rule Script_Execution {
    meta:
        description = "Detects script execution patterns"
        severity = "medium"
    strings:
        $cmd = /cmd\.exe/ ascii nocase
        $slashc = /\/c / ascii
        $slashC = /\/C / ascii
        $wscript = /wscript\.exe/ ascii nocase
        $cscript = /cscript\.exe/ ascii nocase
    condition:
        2 of them
}

rule Anti_Analysis {
    meta:
        description = "Detects anti-analysis techniques"
        severity = "medium"
    strings:
        $debug = /IsDebuggerPresent/ ascii nocase
        $checkdebug = /CheckRemoteDebuggerPresent/ ascii nocase
        $vmware = /VMware/ ascii nocase
        $virtualbox = /VirtualBox/ ascii nocase
        $sandbox = /sandbox/ ascii nocase
    condition:
        2 of them
}

rule Crypto_Ransomware {
    meta:
        description = "Detects potential ransomware crypto operations"
        severity = "high"
    strings:
        $crypt = /CryptEncrypt/ ascii nocase
        $aes = /AES/ ascii nocase
        $rsa = /RSA/ ascii nocase
        $encrypt = /Encrypt/ ascii nocase
        $fileext = /\.(encrypted|locked|crypto|vault)/ ascii nocase
    condition:
        (2 of ($crypt, $aes, $rsa, $encrypt)) or $fileext
}

rule Keylogger {
    meta:
        description = "Detects keylogging behavior"
        severity = "high"
    strings:
        $getkey = /GetAsyncKeyState/ ascii nocase
        $keylog = /keylog/ ascii nocase
        $keyboard = /keyboard/ ascii nocase
        $hook = /SetWindowsHookEx/ ascii nocase
    condition:
        2 of them
}

rule File_Encryption {
    meta:
        description = "Detects file encryption patterns"
        severity = "medium"
    strings:
        $encryptfile = /EncryptFile/ ascii nocase
        $fileencrypt = /FileEncrypt/ ascii nocase
        $cryptfile = /CryptFile/ ascii nocase
    condition:
        any of them
}

